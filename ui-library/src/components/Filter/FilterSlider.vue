<template>
	<div class="pkpFilter--slider" :class="classes">
		<button v-if="isFilterActive" class="pkpFilter__remove" @click="remove">
			<icon icon="times-circle-o" />
			<span class="-screenReader">
				{{ __('filterRemove', {filterTitle: title}) }}
			</span>
		</button>
		<button v-else class="pkpFilter__add" @click="enable">
			<icon icon="plus-square-o" />
			<span class="-screenReader">
				{{ __('filterAdd', {filterTitle: title}) }}
			</span>
		</button>
		<div
			class="pkpFilter__inputTitle"
			:tabindex="!isFilterActive ? -1 : false"
			aria-hidden="true"
			@click="toggle"
		>
			{{ title }}
		</div>
		<div class="pkpFilter__input pkpFilter__input--slider">
			<label class="-screenReader" for="slider">{{ title }}</label>
			<input
				type="range"
				:max="max"
				:min="min"
				:disabled="!isFilterActive"
				id="slider"
				v-model="currentValue"
			/>
			<output
				ref="output"
				v-if="isFilterActive"
				class="pkpFilter__value"
				:style="valueStyles"
			>
				{{ currentValue }}
			</output>
		</div>
	</div>
</template>

<script>
import Filter from './Filter.vue';
import debounce from 'debounce';

export default {
	extends: Filter,
	props: {
		formatter: {
			type: String,
			default() {
				return '';
			}
		},
		isVisible: {
			type: Boolean,
			required: true
		},
		max: {
			type: Number,
			required: true
		},
		min: {
			type: Number,
			required: true
		},
		starLabel: {
			type: String,
			default() {
				return '';
			}
		},
		useStars: {
			type: Boolean,
			default() {
				return false;
			}
		}
	},
	data() {
		return {
			currentValue: this.value
		};
	},
	computed: {
		/**
		 * Classes to apply to the root element
		 *
		 * @return {Array}
		 */
		classes() {
			let classes = Filter.computed.classes.apply(this);
			if (this.isVisible) {
				classes.push('-isVisible');
			}
			return classes;
		},
		/**
		 * A unique ID to use as the reference for the slider
		 *
		 * @return {String}
		 */
		sliderRef() {
			return 'slider' + this.param;
		},
		valueStyles() {
			if (this.isFilterActive) {
				const position = Number(
					((this.currentValue - this.min) * 100) / (this.max - this.min)
				);
				// The numbers here account for the way that the native input
				// range filter aligns the handle on the left and right. The
				// exact position of the center of the handle is not the same
				// as position. The offset here accounts for the shift in
				// position that must occur when the handle is on the left
				// or right of the range.
				const offset = 8 + (position / 100) * -17;
				return {
					left: `calc(${position}% + ${offset}px)`
				};
			}
			return {};
		}
	},
	methods: {
		/**
		 * Enable the filter and emit an event to update active
		 * filters with the current value
		 */
		enable() {
			this.$emit('add-filter', this.param, parseInt(this.currentValue, 0));
		},

		/**
		 * Emit an event to update active filters with the current
		 * value.
		 *
		 * Throttle this method so that sliders don't fire off dozens of
		 * events as they're being moved.
		 */
		updateCurrentValue: debounce(function(value) {
			this.$emit('update-filter', this.param, parseInt(value, 0));
		}, 250),

		/**
		 * @copydoc Filter::remove()
		 */
		remove() {
			this.$emit('remove-filter', this.param);
		}
	},
	mounted() {
		// this.showValueBubble(this.currentValue);
	},
	watch: {
		currentValue: function(newVal, oldVal) {
			if (newVal === oldVal) {
				return;
			} else {
				this.updateCurrentValue(newVal);
				return newVal;
			}
		}
	}
};
</script>

<style lang="less">
@import '../../styles/_import';

.pkpFilter--slider {
	padding-left: 1rem;
	padding-right: 1rem;
}

.pkpFilter--slider.pkpFilter--disabled {
	.pkpFilter__input {
		opacity: 0.5;
	}

	.vue-slider-tooltip,
	.vue-slider-tooltip--stars,
	.vue-slider-process {
		display: none !important;
	}
}

.pkpFilter--slider .pkpFilter__add,
.pkpFilter--slider .pkpFilter__remove {
	top: 0.6rem;
}

.pkpFilter__input--slider {
	// margin-left: -8px;
	// margin-right: -8px;
	padding-bottom: 3em; // account for title space
	position: relative;
}

.pkpFilter__inputTitle {
	margin-right: @base;
	color: @primary;
	cursor: pointer;
	line-height: 1.5em;
}

.vue-slider-component {
	.vue-slider-tooltip {
		border-color: @primary;
		background: @primary;
		font-size: @font-tiny;
		line-height: 1.5em;
	}

	.vue-slider-tooltip-wrap.vue-slider-tooltip-bottom
		.vue-slider-tooltip::before {
		border-bottom-color: @primary;
	}

	.vue-slider-process {
		background: @primary;
	}
}

.vue-slider-component--stars .vue-slider-tooltip-wrap {
	width: 70px;
	text-align: center;

	.fa {
		color: @star-on;
	}
}

.pkpFilter__value {
	position: absolute;
	top: 2rem;
	background-color: #3498db;
	text-align: center;
	padding: 0 0.5em;
	line-height: @line-sml;
	color: white;
	border-radius: @radius;
	display: inline-block;
	transform: translateX(-50%);

	&:after {
		content: '';
		position: absolute;
		width: 0;
		height: 0;
		border-bottom: @half solid #3498db;
		border-left: @half solid transparent;
		border-right: @half solid transparent;
		bottom: 100%;
		left: 50%;
		transform: translateX(-50%);
	}
}

input[type='range'] {
	-webkit-appearance: none; /* Hides the slider so that custom slider can be made */
	width: 100%; /* Specific width is required for Firefox. */
	background: transparent; /* Otherwise white in Chrome */
	margin-left: 0;
}

input[type='range']::-webkit-slider-thumb {
	-webkit-appearance: none;
}

input[type='range']:focus {
	outline: none; /* Removes the blue border. You should probably do some kind of focus styling for accessibility reasons though. */
}

input[type='range']::-webkit-slider-thumb {
	-webkit-appearance: none;
	height: @base;
	width: @base;
	border-radius: 50%;
	background-color: #fff;
	box-shadow: 0.5px 0.5px 2px 1px rgba(0, 0, 0, 0.32);
}

/* All the same stuff for Firefox */
input[type='range']::-moz-range-thumb {
	height: @base;
	width: @base;
	border-radius: 50%;
	background-color: #fff;
	box-shadow: 0.5px 0.5px 2px 1px rgba(0, 0, 0, 0.32);
}

/* All the same stuff for IE */
input[type='range']::-ms-thumb {
	height: @base;
	width: @base;
	border-radius: 50%;
	background-color: #fff;
	box-shadow: 0.5px 0.5px 2px 1px rgba(0, 0, 0, 0.32);
}

input[type='range']::-ms-track {
	width: 100%;
	cursor: pointer;

	/* Hides the slider so custom styles can be added */
	background: transparent;
	border-color: transparent;
	color: transparent;
}

input[type='range']::-webkit-slider-runnable-track {
	width: 100%;
	height: 7px;
	cursor: pointer;
	border-radius: 15px;
	background-color: #ccc;
}

input[type='range']:focus::-webkit-slider-runnable-track {
	background: #367ebd;
}

input[type='range']::-moz-range-track {
	width: 100%;
	height: 7px;
	cursor: pointer;
	border-radius: 15px;
	background-color: #ccc;
}

input[type='range']::-ms-track {
	width: 100%;
	height: 7px;
	cursor: pointer;
	border-radius: 15px;
	background-color: #ccc;
}
input[type='range']::-ms-fill-lower {
	background: #0064b4;
	border-radius: 15px;
}
input[type='range']:focus::-ms-fill-lower {
	background: #0064b4;
}
input[type='range']::-ms-fill-upper {
	background: #0064b4;
	border-radius: 15px;
}
input[type='range']:focus::-ms-fill-upper {
	background: #0064b4;
}
</style>
