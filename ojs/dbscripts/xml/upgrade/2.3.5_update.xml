<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE data SYSTEM "../../../lib/pkp/dtd/xmlData.dtd">

<!--
  * 2.3.5_update.xml
  *
  * Copyright (c) 2003-2011 John Willinsky
  * Distributed under the GNU GPL v2. For full terms see the file docs/COPYING.
  *
  * 2.3.5 database updates XML file.
  -->
<data>
	<!-- Bug #6451: Check and purge incorrect publication date data -->
	<!--
	  - 1. Drop the NOT NULL constraint on pa.date_published. This is not
	  -    reliably done by ADODB. 
	  -->
	<sql>
		<query driver="mysql">ALTER TABLE published_articles CHANGE COLUMN date_published date_published DATETIME</query>
		<query driver="postgres7">ALTER TABLE published_articles ALTER COLUMN date_published DROP NOT NULL</query>
	</sql>

	<!--
	  - 2. Null out pa.date_published from entries where there is a duped
	  -    editor decision entry. (See bug #6428.) Duplicate entries help
	  -    us to identify submissions that were created via the QuickSubmit
	  -    or Expedited Submission processes (i.e. the two cases where
	  -    publication dates will be incorrect).
	  -->
	<sql>
		<query driver="mysql">UPDATE published_articles pa, edit_decisions e1, edit_decisions e2, articles a SET pa.date_published = NULL WHERE pa.article_id = a.article_id AND e1.article_id = a.article_id AND e2.article_id = a.article_id AND e1.edit_decision_id <> e2.edit_decision_id AND e1.date_decided = e2.date_decided AND pa.date_published >= a.date_submitted</query>
		<query driver="postgres7">UPDATE published_articles SET date_published = NULL WHERE article_id IN (SELECT DISTINCT a.article_id FROM articles a, published_articles pa, edit_decisions e1, edit_decisions e2 WHERE pa.article_id = a.article_id AND e1.article_id = a.article_id AND e2.article_id = a.article_id AND e1.edit_decision_id <> e2.edit_decision_id AND e1.date_decided = e2.date_decided AND pa.date_published >= a.date_submitted)</query>
	</sql>
</data>
